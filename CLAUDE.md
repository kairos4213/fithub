# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

FitHub is a fitness tracking web app built with Go. Users log body metrics, set goals, create/schedule workouts, and track exercises with reps/sets/weights.

## Development Commands

- `make dev` — starts all dev services concurrently (tailwind, templ, air hot-reload server, static sync)
- `make server` — runs only the Go server with air hot-reload
- `make templ` — watches and regenerates templ templates
- `make tailwind` — watches and compiles Tailwind CSS
- `go test ./...` — run all tests
- `go test ./internal/auth/` — run tests for a single package
- `sqlc generate` — regenerate database query code from `sql/queries/` into `internal/database/`
- `goose -dir sql/schema postgres "$DATABASE_URL" up` — run database migrations

## Environment

Requires a `.env` file with: `DATABASE_URL`, `PORT`, `FILEPATH_ROOT`, `TOKEN_SECRET`.

## Architecture

**Stack:** Go stdlib `net/http` router (Go 1.22+ verb patterns), Templ templates, HTMX + Alpine.js, Tailwind CSS + DaisyUI, PostgreSQL with sqlc.

**Key directories:**
- `internal/handlers/` — HTTP handlers split into HTML handlers (server-rendered pages via templ) and JSON API handlers (`api_*.go` files). Both share a single `Handler` struct backed by `config.Config`.
- `internal/templates/` — Templ `.templ` files. `layout.templ` is the shared page shell. Each feature has its own template file.
- `internal/database/` — **Generated by sqlc, do not edit manually.** Models and query functions generated from `sql/queries/` and `sql/schema/`.
- `internal/middleware/` — Middleware stack: SecureHeaders → Cop (CORS) → RateLimit → Log → Auth. Auth middleware reads JWT from cookies (HTML routes) or Bearer tokens (API routes).
- `internal/auth/` — JWT token creation/validation, Argon2id password hashing.
- `internal/validate/` — Field validation (Required, MinLen, MaxLen, Numeric, etc.) returning field-level errors for form rendering.
- `internal/server/` — Server setup and route registration. Routes are defined in `routes.go`.
- `sql/schema/` — Goose migration files (numbered `001_` through `011_`).
- `sql/queries/` — SQL query definitions consumed by sqlc.

**Dual routing pattern:** The app serves both server-rendered HTML pages (under `/workouts`, `/metrics`, `/goals`, etc.) and a JSON REST API (under `/api/v1/`). HTML routes use cookie-based auth; API routes use Bearer token auth. Both are handled by the same `Handler` struct.

**Rendering flow:** Handlers call templ component functions, which return `templ.Component`. HTMX handles partial page updates by swapping HTML fragments returned from the server.

**Database workflow:** Write SQL in `sql/queries/`, run `sqlc generate`, use the generated Go functions in handlers. Never edit files in `internal/database/` directly.
